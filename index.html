<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Juh Nails Pro V14</title>
    <style>
        :root { --pri: #6A1B9A; --sec: #E1BEE7; --fundo: #F3E5F5; --txt: #4A148C; --wzap: #25D366; }
        body { font-family: sans-serif; background: var(--fundo); color: var(--txt); padding: 5px; margin:0; }
        
        .main-layout { display: flex; gap: 10px; height: 98vh; }
        .sidebar { width: 100px; background: white; border-radius: 10px; padding: 10px; overflow-y: auto; display: flex; flex-direction: column; gap: 5px; }
        .workspace { flex: 1; background: white; border-radius: 10px; padding: 15px; overflow-y: auto; position: relative; }
        
        .month-btn { padding: 10px 5px; border: none; background: #eee; border-radius: 5px; cursor: pointer; text-align: left; font-size: 11px; display: flex; justify-content: space-between; align-items: center; }
        .month-btn.active { background: var(--pri); color: white; font-weight: bold; }
        .badge { background: #D32F2F; color: white; border-radius: 10px; padding: 2px 6px; font-size: 9px; font-weight: bold; min-width: 15px; text-align: center; }
        .badge-day { position: absolute; top: -5px; right: -5px; background: #D32F2F; color: white; border-radius: 50%; width: 16px; height: 16px; font-size: 9px; display: flex; align-items: center; justify-content: center; z-index: 2; }

        .cal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; text-align: center; }
        .cal-day { padding: 12px 2px; border: 1px solid #eee; border-radius: 5px; cursor: pointer; font-size: 12px; position: relative; }
        .has-event { background: #f3e5f5; font-weight: bold; border-color: var(--pri); }
        
        .day-modal { display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 10; padding: 15px; box-sizing: border-box; overflow-y: auto; }
        .day-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .slot-row { display: flex; align-items: center; border-bottom: 1px solid #f0f0f0; padding: 3px 0; min-height: 25px; }
        .slot-time { width: 45px; font-weight: bold; font-size: 11px; color: #666; }
        .slot-content { flex: 1; margin-left: 8px; }
        
        .slot-ocupado { padding: 4px 8px; border-radius: 4px; color: #333; width: 100%; font-size: 11px; display: flex; justify-content: space-between; align-items: center; box-sizing: border-box; border-left: 3px solid rgba(0,0,0,0.2); }
        .btn-agendar-mini { background: none; border: 1px dashed #ccc; color: #888; border-radius: 15px; padding: 2px 10px; font-size: 10px; cursor: pointer; transition: 0.2s; }
        .btn-agendar-mini:hover { border-color: var(--pri); color: var(--pri); background: #f3e5f5; }

        /* Bot√µes de A√ß√£o */
        .action-btns { display: flex; gap: 5px; align-items: center; }
        .btn-zap { background: var(--wzap); color: white; border: none; padding: 2px 6px; border-radius: 4px; cursor: pointer; font-size: 10px; }
        .btn-trash { background: none; border: none; cursor: pointer; font-size: 14px; opacity: 0.6; }
        .btn-trash:hover { opacity: 1; transform: scale(1.1); color: red; }

        .client-item { padding: 10px; border-bottom: 1px solid #eee; font-size: 12px; display: flex; justify-content: space-between; align-items: center; }
        .client-item:hover { background: #f0f0f0; }
        .btn-quick-book { background: var(--pri); color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 10px; margin-left: 5px; }

        .history-item { background: #f9f9f9; padding: 8px; margin-bottom: 5px; border-radius: 5px; border-left: 3px solid var(--pri); font-size: 11px; display: flex; justify-content: space-between; align-items: center; }
        
        .booking-modal { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border-radius: 10px; box-shadow: 0 0 20px rgba(0,0,0,0.3); z-index: 20; width: 300px; }
        .overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 15; }

        input, select, textarea { width: 100%; padding: 8px; margin: 5px 0; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box; }
        .tab-nav { display:flex; gap:5px; margin-bottom:10px; }
        .nav-btn { flex:1; padding:8px; border:none; background:#eee; cursor:pointer; border-radius: 5px; font-size: 11px; }
        .nav-btn.active { background:var(--pri); color:white; }
        .hidden { display:none; }
    </style>
</head>
<body>

<div class="main-layout">
    <div class="sidebar" id="listaMeses"></div>
    <div class="workspace">
        <div class="tab-nav">
            <button class="nav-btn active" onclick="switchView('view-cal')">üìÖ Agenda</button>
            <button class="nav-btn" onclick="switchView('view-cli')">üë• Clientes</button>
            <button class="nav-btn" onclick="switchView('view-conf')">‚öôÔ∏è Ajustes</button>
        </div>

        <div id="view-cal">
            <div class="cal-header"><h3 id="tituloMes" style="margin:0"></h3><small id="tituloAno">2026</small></div>
            <div class="cal-grid" id="gridDias"></div>
        </div>

        <div id="view-cli" class="hidden">
            <div style="display:flex; gap:5px; margin-bottom:5px">
                <input type="text" id="buscaCli" placeholder="üîç Buscar..." oninput="renderizarListaClientes()" style="flex:1; margin:0">
                <button onclick="abrirNovoCliente()" style="width:auto; background:var(--pri); color:white; border:none; border-radius:5px; font-size:12px; padding:0 10px">‚ûï</button>
            </div>
            <div id="listaDeClientes" style="max-height: 200px; overflow-y: auto;"></div>
            <div id="detalheCliente" class="hidden" style="margin-top:15px; border-top:2px solid var(--sec); padding-top:10px;">
                <h4 id="titDetalhe">Dados do Cliente</h4>
                <input type="text" id="edit-cli-nome" readonly style="background:#eee">
                <input type="text" id="edit-cli-whats" placeholder="WhatsApp">
                <button onclick="salvarEdicaoCliente()" style="width:100%; background:var(--pri); color:white; padding:8px; border:none; border-radius:5px">SALVAR CADASTRO</button>
                <div id="historicoCliente" style="max-height:150px; overflow-y:auto; margin-top:10px"></div>
            </div>
        </div>

        <div id="view-conf" class="hidden">
            <h4>Servi√ßos</h4>
            <input type="hidden" id="s-antigo"><input type="text" id="s-nome" placeholder="Servi√ßo"><div style="display:flex; gap:5px"><input type="number" id="s-preco" placeholder="R$"><input type="number" id="s-dur-base" placeholder="Min"></div><button onclick="salvarSer()" style="width:100%; background:var(--pri); color:white; padding:8px; border:none; border-radius:5px">SALVAR SERVI√áO</button>
            <div id="list-ser" style="margin-top:10px; max-height:200px; overflow-y:auto"></div>
            <hr>
            <h4>Mensagens</h4>
            <textarea id="msg-conf" rows="2"></textarea><button onclick="salvarMsg('Confirmacao')" style="width:100%; background:var(--pri); color:white; padding:5px; border:none; border-radius:5px; margin-bottom:5px">Salvar Confirma√ß√£o</button>
            <textarea id="msg-lemb" rows="2"></textarea><button onclick="salvarMsg('Lembrete')" style="width:100%; background:var(--pri); color:white; padding:5px; border:none; border-radius:5px">Salvar Lembrete</button>
        </div>

        <div id="modalDia" class="day-modal">
            <div class="day-header">
                <button onclick="fecharDia()" style="border:none; background:#eee; padding:5px 10px; border-radius:5px; cursor:pointer; font-size:11px">‚¨Ö Voltar</button>
                <h3 id="tituloDia" style="margin:0; font-size:16px"></h3>
                <button onclick="fecharDia()" style="border:none; background:#ccc; padding:5px 8px; border-radius:3px; cursor:pointer">‚úï</button>
            </div>
            <div id="listaSlots"></div>
        </div>
    </div>
</div>

<div class="overlay" id="overlay"></div>
<div class="booking-modal" id="modalBooking">
    <h3 style="margin-top:0">Novo Agendamento</h3>
    <input type="text" id="a-cli" list="l-cli" onblur="autoWhats()" placeholder="Cliente">
    <datalist id="l-cli"></datalist>
    <input type="text" id="a-whats" placeholder="WhatsApp">
    <select id="a-ser" onchange="autoPreco()"></select>
    <div style="display:flex; gap:5px"><input type="number" id="a-val" placeholder="R$"><input type="number" id="a-dur" placeholder="Min"></div>
    <label style="font-size:10px">Data/Hora:</label>
    <input type="datetime-local" id="a-data">
    <button onclick="salvarAge()" style="width:100%; background:var(--pri); color:white; padding:10px; border:none; border-radius:5px; margin-top:10px">CONFIRMAR</button>
    <button onclick="fecharBooking()" style="width:100%; background:#ccc; padding:5px; border:none; border-radius:5px; margin-top:5px">CANCELAR</button>
</div>

<script>
    // --- COLE SUA URL AQUI ---
    const URL_API = "https://script.google.com/macros/s/AKfycbzYCOlD_XFQwgpApyRx68sASAjEjjWPzMwdAFtRxgZKz8rTlIdqX5y1MwLIXYM1fx4i/exec"; 
    
    let db = { servicos: [], clientes: [], agenda: [], config: [] };
    let anoAtual = new Date().getFullYear();
    let mesAtual = new Date().getMonth();
    const HORA_INICIO = 8; const HORA_FIM = 20; const INTERVALO = 15;

    async function carregar(diaParaReabrir = null) {
        const res = await fetch(URL_API);
        db = await res.json();
        renderizarMeses();
        renderizarCalendario(mesAtual);
        renderizarConfig();
        renderizarListaClientes();
        if (diaParaReabrir) abrirDia(diaParaReabrir);
    }

    function gerarCor(nome) {
        let hash = 0; for (let i = 0; i < nome.length; i++) { hash = nome.charCodeAt(i) + ((hash << 5) - hash); }
        let cor = '#'; for (let i = 0; i < 3; i++) { let value = (hash >> (i * 8)) & 0xFF; value = Math.floor((value + 300) / 2); cor += ('00' + value.toString(16)).substr(-2); }
        return cor;
    }

    function abrirDia(dia) {
        document.getElementById('modalDia').style.display = 'block';
        document.getElementById('tituloDia').innerText = `Dia ${dia}/${mesAtual+1}`;
        const container = document.getElementById('listaSlots'); container.innerHTML = "";
        const agendamentosDia = db.agenda.filter(a => { let d = new Date(a[3]); return d.getDate() === dia && d.getMonth() === mesAtual && d.getFullYear() === anoAtual; });
        let horaAtual = new Date(anoAtual, mesAtual, dia, HORA_INICIO, 0, 0);
        let fimDoDia = new Date(anoAtual, mesAtual, dia, HORA_FIM, 0, 0);

        while (horaAtual < fimDoDia) {
            let horaStr = horaAtual.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            let ocupante = agendamentosDia.find(a => { let ini = new Date(a[3]); let fim = new Date(a[4]); return horaAtual >= ini && horaAtual < fim; });
            let htmlSlot = "";
            
            if (ocupante) {
                let corFundo = gerarCor(ocupante[0]);
                htmlSlot = `<div class="slot-ocupado" style="background:${corFundo}">
                    <span style="font-weight:bold; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; max-width:140px">${ocupante[0]}</span>
                    <div class="action-btns">
                        <button onclick="enviarZap('${ocupante[0]}','${ocupante[1]}','${ocupante[5]}','${ocupante[3]}','Lembrete')" class="btn-zap">üì±</button>
                        <button onclick="excluirAgendamento('${ocupante[0]}','${ocupante[3]}')" class="btn-trash" title="Excluir">üóëÔ∏è</button>
                    </div>
                </div>`;
            } else {
                let isoDate = new Date(horaAtual.getTime() - (horaAtual.getTimezoneOffset() * 60000)).toISOString().slice(0,16);
                htmlSlot = `<button class="btn-agendar-mini" onclick="abrirBooking('${isoDate}')">‚ûï Agendar</button>`;
            }
            container.innerHTML += `<div class="slot-row"><div class="slot-time">${horaStr}</div><div class="slot-content">${htmlSlot}</div></div>`;
            horaAtual = new Date(horaAtual.getTime() + INTERVALO * 60000);
        }
    }

    // NAVEGA√á√ÉO
    function renderizarMeses() {
        const meses = ["Jan", "Fev", "Mar", "Abr", "Mai", "Jun", "Jul", "Ago", "Set", "Out", "Nov", "Dez"];
        document.getElementById('listaMeses').innerHTML = meses.map((m, i) => {
            let count = db.agenda.filter(a => new Date(a[3]).getMonth() === i && new Date(a[3]).getFullYear() === anoAtual).length;
            let badge = count > 0 ? `<span class="badge">${count}</span>` : '';
            return `<button class="month-btn ${i===mesAtual?'active':''}" onclick="mudarMes(${i})"><span>${m}</span> ${badge}</button>`;
        }).join('');
    }
    
    function mudarMes(i) { mesAtual = i; switchView('view-cal'); renderizarMeses(); renderizarCalendario(i); }

    function renderizarCalendario(mes) {
        const grid = document.getElementById('gridDias'); grid.innerHTML = "";
        document.getElementById('tituloMes').innerText = ["Janeiro", "Fevereiro", "Mar√ßo", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"][mes];
        const diasNoMes = new Date(anoAtual, mes + 1, 0).getDate();
        for(let i=1; i<=diasNoMes; i++) {
            let countDia = db.agenda.filter(a => { let d = new Date(a[3]); return d.getDate() === i && d.getMonth() === mes && d.getFullYear() === anoAtual; }).length;
            let badgeHtml = countDia > 0 ? `<div class="badge-day">${countDia}</div>` : '';
            grid.innerHTML += `<div class="cal-day ${countDia>0?'has-event':''}" onclick="abrirDia(${i})">${i} ${badgeHtml}</div>`;
        }
    }

    function renderizarConfig() {
        document.getElementById('msg-conf').value = db.config[0][1];
        document.getElementById('msg-lemb').value = db.config[1][1];
        document.getElementById('a-ser').innerHTML = db.servicos.map(s => `<option value="${s[0]}" data-p="${s[1]}" data-d="${s[2]}">${s[0]}</option>`).join('');
        document.getElementById('l-cli').innerHTML = db.clientes.map(c => `<option value="${c[0]}">`).join('');
        document.getElementById('list-ser').innerHTML = db.servicos.map(s => `<div style="border-bottom:1px solid #eee; padding:5px; font-size:12px; display:flex; justify-content:space-between"><span>${s[0]}</span><div><button onclick="edSer('${s[0]}',${s[1]},${s[2]})" style="font-size:10px; padding:2px 5px">ED</button><button onclick="excluirServico('${s[0]}')" style="font-size:10px; padding:2px 5px; background:transparent; border:none; cursor:pointer">üóëÔ∏è</button></div></div>`).join('');
        autoPreco();
    }

    function renderizarListaClientes() {
        const busca = document.getElementById('buscaCli').value.toLowerCase();
        document.getElementById('listaDeClientes').innerHTML = db.clientes.filter(c => c[0].toLowerCase().includes(busca)).map(c => `<div class="client-item"><span class="client-name" onclick="abrirDetalheCliente('${c[0]}','${c[1]}')">${c[0]}</span><button class="btn-quick-book" onclick="abrirBooking(null, '${c[0]}', '${c[1]}')">üìÖ Agendar</button></div>`).join('');
    }

    async function excluirServico(nome) {
        if(!confirm("Excluir servi√ßo " + nome + "?")) return;
        await fetch(URL_API, { method: 'POST', body: JSON.stringify({acao: "excluirServico", nome: nome}) });
        alert("Servi√ßo Excluido!");
        carregar();
    }

    async function excluirAgendamento(nome, dataISO) {
        if(!confirm("Excluir agendamento?")) return;
        const res = await fetch(URL_API, { method: 'POST', body: JSON.stringify({acao: "excluirAgendamento", cliente: nome, dataHora: dataISO}) });
        alert(await res.text()); 
        
        if(!document.getElementById('detalheCliente').classList.contains('hidden')) {
            carregar();
            setTimeout(() => abrirDetalheCliente(nome, document.getElementById('edit-cli-whats').value), 1000);
        } else {
            let d = new Date(dataISO);
            carregar(d.getDate()); 
        }
    }

    async function salvarAge() {
        let whats = formatarWhatsApp(document.getElementById('a-whats').value);
        let d = { acao: "agendar", cliente: document.getElementById('a-cli').value, servico: document.getElementById('a-ser').value, valor: document.getElementById('a-val').value, duracao: document.getElementById('a-dur').value, dataHora: document.getElementById('a-data').value, whats: whats };
        const res = await fetch(URL_API, { method: 'POST', body: JSON.stringify(d) });
        const texto = await res.text();
        if(texto.includes("ERRO")) alert(texto); else { alert("OK!"); enviarZap(d.cliente, d.servico, whats, d.dataHora, 'Confirmacao'); fecharBooking(); carregar(new Date(d.dataHora).getDate()); }
    }

    // Auxiliares
    function abrirDetalheCliente(nome, whats) { 
        document.getElementById('detalheCliente').classList.remove('hidden'); 
        document.getElementById('titDetalhe').innerText="Editar Cliente"; 
        document.getElementById('edit-cli-nome').value=nome; 
        document.getElementById('edit-cli-nome').setAttribute('readonly',true); 
        document.getElementById('edit-cli-nome').style.background="#eee"; 
        document.getElementById('edit-cli-whats').value=whats; 
        
        const h = db.agenda.filter(a => a[0] === nome).sort((a,b) => new Date(b[3]) - new Date(a[3])); 
        document.getElementById('historicoCliente').innerHTML = h.length ? h.map(x => `
            <div class="history-item">
                <div>${new Date(x[3]).toLocaleDateString()} ${new Date(x[3]).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})}<br>${x[1]}</div>
                <div class="action-btns">
                    <button onclick="enviarZap('${nome}','${x[1]}','${x[5]}','${x[3]}','Lembrete')" class="btn-zap">üì±</button>
                    <button class="btn-trash" onclick="excluirAgendamento('${nome}', '${x[3]}')" title="Excluir">üóëÔ∏è</button>
                </div>
            </div>`).join('') : "<p style='font-size:11px'>Sem hist√≥rico.</p>"; 
    }

    function abrirNovoCliente() { document.getElementById('detalheCliente').classList.remove('hidden'); document.getElementById('titDetalhe').innerText="Novo Cadastro"; document.getElementById('edit-cli-nome').value=""; document.getElementById('edit-cli-nome').removeAttribute('readonly'); document.getElementById('edit-cli-nome').style.background="white"; document.getElementById('edit-cli-whats').value=""; document.getElementById('historicoCliente').innerHTML=""; }
    function salvarEdicaoCliente() { let n=document.getElementById('edit-cli-nome').value, w=formatarWhatsApp(document.getElementById('edit-cli-whats').value); fetch(URL_API, { method: 'POST', body: JSON.stringify({acao: "salvarCliente", nome: n, whats: w}) }).then(() => { alert("Salvo!"); carregar(); }); }
    function salvarSer() { fetch(URL_API, { method: 'POST', body: JSON.stringify({acao: "salvarServico", nome: document.getElementById('s-nome').value, preco: document.getElementById('s-preco').value, duracao: document.getElementById('s-dur-base').value, nomeAntigo: document.getElementById('s-antigo').value })}).then(() => { alert("Salvo!"); carregar(); }); }
    function salvarMsg(t) { fetch(URL_API, { method: 'POST', body: JSON.stringify({acao:"salvarConfig", tipo:t, msg: t==='Confirmacao'?document.getElementById('msg-conf').value:document.getElementById('msg-lemb').value}) }).then(() => alert("Salvo!")); }
    function enviarZap(c,s,w,d,t) { let txt = (t==='Lembrete'?document.getElementById('msg-lemb').value:document.getElementById('msg-conf').value).replace('{cliente}',c).replace('{servico}',s).replace('{data}',new Date(d).toLocaleDateString()).replace('{hora}',new Date(d).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})); window.open(`https://wa.me/${w.replace(/\D/g,'')}?text=${encodeURIComponent(txt)}`); }
    function formatarWhatsApp(n) { let l=n.toString().replace(/\D/g,''); if(l.length==8||l.length==9)return "5551"+l; if(l.length==10||l.length==11)return "55"+l; return l; }
    function autoWhats() { let c=db.clientes.find(x=>x[0].toLowerCase()===document.getElementById('a-cli').value.toLowerCase()); if(c)document.getElementById('a-whats').value=c[1]; }
    function autoPreco() { let s=document.getElementById('a-ser').selectedOptions[0]; if(s){document.getElementById('a-val').value=s.dataset.p;document.getElementById('a-dur').value=s.dataset.d;} }
    function fecharDia() { document.getElementById('modalDia').style.display='none'; }
    function fecharBooking() { document.getElementById('overlay').style.display='none'; document.getElementById('modalBooking').style.display='none'; }
    function switchView(id) { document.getElementById('view-cal').classList.add('hidden'); document.getElementById('view-cli').classList.add('hidden'); document.getElementById('view-conf').classList.add('hidden'); document.getElementById(id).classList.remove('hidden'); }
    function edSer(n,p,d) { document.getElementById('s-nome').value=n; document.getElementById('s-preco').value=p; document.getElementById('s-dur-base').value=d; document.getElementById('s-antigo').value=n; switchView('view-conf'); }
    function abrirBooking(d,n,w) { document.getElementById('overlay').style.display='block'; document.getElementById('modalBooking').style.display='block'; document.getElementById('a-data').value=d||""; document.getElementById('a-cli').value=n||""; document.getElementById('a-whats').value=w||""; if(n&&!w)autoWhats(); }

    window.onload = function() { carregar(); }
</script>
</body>
</html>
